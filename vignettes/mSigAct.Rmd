---
title: "Introduction to mSigAct"
author: "Steven G. Rozen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Background

'mSigAct' stands for **m**tational **Sig**nature
**Act**ivity. 
mSigAct provides two major analytical capabilities. 

* It can estimate (conservatively) whether there is evidence
    that a particular mutational signature is present in a spectrum.
    The function for this is `SignaturePresenceTest1`.
    
* It can
    determine a minimal subset of signatures needed to plausibly reconstruct an
    observed spectrum. The function for this is `SparseAssignActivity`.
    
The concepts behind these two capabilities were
described in Ng et al., 2017, "Aristolochic acids and their derivatives are widely 
implicated in liver cancers in Taiwan and throughout Asia", Science Translational Medicine 2017
<https://doi.org/10.1126/scitranslmed.aan6446>. 

We are currently working on a third capability:

* Decompose each of several spectra that were observed in
cells exposed to a mutagen into two components:

    + A component generated by the background signature
that the cells always generate,
regardless of exposure to the mutagen.

    + A component due to the mutagenic exposure.

## The SparseAssignActivity function

We show how to run `SparseAssignActivity` on demo 
mutational spectrum data 
(`mSigAct::BTSG.WGS.PCAWG`)
that is provided with the package. 
We also use the package variable `mSigAct::sp.sigs`,
which contains mutational signatures as extracted by
SigProfiler on the usual 96-category single base
substitution mutation types (see 
[Alexandrov et al.,](https://www.biorxiv.org/content/10.1101/322859v1))
This variable is an [ICAMS](https://github.com/steverozen/ICAMS/)
`catalog`. In addition, for functions for reading
mutation spectra or signatures from files, see 
[ICAMS](https://github.com/steverozen/ICAMS/).

```{r}
library(mSigAct)

estimated.exposure <- 
  SparseAssignActivity(spectra  = mSigAct::BTSG.WGS.PCAWG[ , 1:3],
                       sigs     = mSigAct::sp.sigs[ ,c("SBS1", "SBS5")],
                       mc.cores = 1)

estimated.exposure
```
`SparseAssignActivity` finds an optimal reconstruction of 
each of the observed `spectra` (independently) using a subset of
the signatures provided in the argument `sigs`. 
Normally these signatures should be those previously observed in
the cancer type in which `spectra` were observed.

Each spectrum in `spectra` can
be analyzed in a separate 
sub-process using the `parallel` package.
The argument `mc.cores` specifies the
number of cores to use.
Here set `mc.cores = 1` because
automatic checking services such as 
CRAN do not permit
spawning sub-processes. By default
`mc.cores` is min of
10 or the number of input spectra.
You will probably want to select
a reasonable number of cores for your system.

`SparseAssignActivity` uses the
[nloptr](https://CRAN.R-project.org/package=nloptr)
package to do numerical non-linear
optimization to find the signature assignment. There is
an optional parameter `m.opts` to `SparseAssignActivity` that
allows control over this search. In fact,
`SparseAssignActivity` first does a global
optimization, because there seem to be local 
optima, followed by  a local optimization.
If `SparseAssignActivity` 
takes excessively long, or if you suspect that it has found
a local (as opposed to global) optimum, you can
try adjusting the components of `m.opts`.
For tracing the progress of the optimizations, you can try

```{r}
m.opts <- DefaultManyOpts()
m.opts$global.opts$print_level <- 1
```

Then call `SparseAssignActivity` as above, with the additional
argument `m.opts = m.opts`.


To do: need to document basic concepts.

To do: Describe concept of available signatures, and where to find 
which ones have been observed where. As Wu Yang to provide the appropriate
data.

To do: Note that `SparseAssignActivity`currently only works on one
cancer type at a time.
